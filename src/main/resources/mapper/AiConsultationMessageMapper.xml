<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hospital.registration.mapper.AiConsultationMessageMapper">

    <resultMap id="BaseResultMap" type="com.hospital.registration.entity.AiConsultationMessage">
        <id column="id" property="id"/>
        <result column="session_id" property="sessionId"/>
        <result column="role" property="role"/>
        <result column="content" property="content"/>
        <result column="recommended_department_id" property="recommendedDepartmentId"/>
        <result column="recommended_doctor_id" property="recommendedDoctorId"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <resultMap id="VOResultMap" type="com.hospital.registration.vo.AiMessageVO">
        <id column="id" property="id"/>
        <result column="role" property="role"/>
        <result column="content" property="content"/>
        <result column="recommended_department_id" property="recommendedDepartmentId"/>
        <result column="recommended_department_name" property="recommendedDepartmentName"/>
        <result column="recommended_doctor_id" property="recommendedDoctorId"/>
        <result column="recommended_doctor_name" property="recommendedDoctorName"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <!-- 查询会话的消息列表（包含科室和医生名称） -->
    <select id="selectBySessionId" resultMap="VOResultMap">
        SELECT m.id, m.role, m.content, m.recommended_department_id, m.recommended_doctor_id, m.create_time,
               d.name AS recommended_department_name,
               NULL AS recommended_doctor_name
        FROM ai_consultation_message m
                 LEFT JOIN department d ON m.recommended_department_id = d.id
        WHERE m.session_id = #{sessionId}
        ORDER BY m.create_time ASC
    </select>

    <!-- 查询会话的消息列表（用于构建上下文） -->
    <select id="selectMessagesBySessionId" resultMap="BaseResultMap">
        SELECT * FROM ai_consultation_message
        WHERE session_id = #{sessionId}
        ORDER BY create_time ASC
    </select>

</mapper>