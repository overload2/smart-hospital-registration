<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hospital.registration.mapper.PaymentMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.hospital.registration.entity.Payment">
        <id column="id" property="id"/>
        <result column="transaction_no" property="transactionNo"/>
        <result column="registration_id" property="registrationId"/>
        <result column="user_id" property="userId"/>
        <result column="amount" property="amount"/>
        <result column="payment_method" property="paymentMethod"/>
        <result column="payment_status" property="paymentStatus"/>
        <result column="payment_time" property="paymentTime"/>
        <result column="refund_time" property="refundTime"/>
        <result column="remark" property="remark"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <!-- 根据挂号ID查询支付记录 -->
    <select id="selectByRegistrationId" resultMap="BaseResultMap">
        SELECT *
        FROM payment
        WHERE registration_id = #{registrationId}
          AND deleted = 0
        LIMIT 1
    </select>

    <!-- 根据交易流水号查询支付记录 -->
    <select id="selectByTransactionNo" resultMap="BaseResultMap">
        SELECT *
        FROM payment
        WHERE transaction_no = #{transactionNo}
          AND deleted = 0
        LIMIT 1
    </select>

    <!-- 查询用户的支付记录 -->
    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT *
        FROM payment
        WHERE user_id = #{userId}
          AND deleted = 0
        ORDER BY create_time DESC
    </select>
    <!-- 分页查询支付记录 -->
    <select id="selectPageWithDetails" resultType="com.hospital.registration.vo.PaymentVO">
        SELECT p.id,
        p.transaction_no,
        p.registration_id,
        r.registration_no,
        p.user_id,
        u.real_name AS patient_name,
        u.phone AS patient_phone,
        p.amount,
        p.payment_method,
        p.payment_status AS paymentStatus,
        p.payment_time,
        p.refund_time,
        p.remark,
        p.create_time
        FROM payment p
        LEFT JOIN registration r ON p.registration_id = r.id
        LEFT JOIN user u ON p.user_id = u.id
        <where>
            p.deleted = 0
            <if test="transactionNo != null and transactionNo != ''">
                AND p.transaction_no LIKE CONCAT('%', #{transactionNo}, '%')
            </if>
            <if test="registrationNo != null and registrationNo != ''">
                AND r.registration_no LIKE CONCAT('%', #{registrationNo}, '%')
            </if>
            <if test="paymentStatus != null and paymentStatus != ''">
                AND p.payment_status = #{paymentStatus}
            </if>
            <if test="paymentMethod != null and paymentMethod != ''">
                AND p.payment_method = #{paymentMethod}
            </if>
            <if test="startDate != null and startDate != ''">
                AND DATE(p.create_time) &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND DATE(p.create_time) &lt;= #{endDate}
            </if>
        </where>
        ORDER BY
        CASE p.payment_status
        WHEN 'REFUND_FAILED' THEN 1
        WHEN 'REFUNDING' THEN 2
        WHEN 'PENDING' THEN 3
        WHEN 'PAID' THEN 4
        WHEN 'REFUNDED' THEN 5
        WHEN 'FAILED' THEN 6
        END ASC,
        p.create_time DESC
    </select>

</mapper>
