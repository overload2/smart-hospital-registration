<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hospital.registration.mapper.MedicalRecordMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.hospital.registration.entity.MedicalRecord">
        <id column="id" property="id"/>
        <result column="registration_id" property="registrationId"/>
        <result column="patient_id" property="patientId"/>
        <result column="doctor_id" property="doctorId"/>
        <result column="chief_complaint" property="chiefComplaint"/>
        <result column="present_illness" property="presentIllness"/>
        <result column="diagnosis" property="diagnosis"/>
        <result column="prescription" property="prescription"/>
        <result column="advice" property="advice"/>
        <result column="visit_time" property="visitTime"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <!-- 详情结果映射（包含关联信息） -->
    <resultMap id="DetailResultMap" type="com.hospital.registration.vo.MedicalRecordVO">
        <id column="id" property="id"/>
        <result column="registration_id" property="registrationId"/>
        <result column="registration_no" property="registrationNo"/>
        <result column="patient_id" property="patientId"/>
        <result column="patient_name" property="patientName"/>
        <result column="patient_gender" property="patientGender"/>
        <result column="patient_age" property="patientAge"/>
        <result column="doctor_id" property="doctorId"/>
        <result column="doctor_name" property="doctorName"/>
        <result column="department_name" property="departmentName"/>
        <result column="chief_complaint" property="chiefComplaint"/>
        <result column="present_illness" property="presentIllness"/>
        <result column="diagnosis" property="diagnosis"/>
        <result column="prescription" property="prescription"/>
        <result column="advice" property="advice"/>
        <result column="visit_time" property="visitTime"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 根据挂号ID查询病历 -->
    <select id="selectByRegistrationId" resultMap="BaseResultMap">
        SELECT *
        FROM medical_record
        WHERE registration_id = #{registrationId}
          AND deleted = 0
        LIMIT 1
    </select>

    <!-- 查询病历详情（包含关联信息） -->
    <select id="selectDetailById" resultMap="DetailResultMap">
        SELECT mr.id,
               mr.registration_id,
               r.registration_no,
               mr.patient_id,
               u1.real_name AS patient_name,
               u1.gender AS patient_gender,
               TIMESTAMPDIFF(YEAR, u1.birth_date, CURDATE()) AS patient_age,
               mr.doctor_id,
               u2.real_name AS doctor_name,
               dep.name AS department_name,
               mr.chief_complaint,
               mr.present_illness,
               mr.diagnosis,
               mr.prescription,
               mr.advice,
               mr.visit_time,
               mr.create_time,
               mr.update_time
        FROM medical_record mr
                 LEFT JOIN registration r ON mr.registration_id = r.id
                 LEFT JOIN user u1 ON mr.patient_id = u1.id
                 LEFT JOIN user u2 ON mr.doctor_id = u2.id
                 LEFT JOIN doctor d ON mr.doctor_id = d.user_id
                 LEFT JOIN department dep ON d.department_id = dep.id
        WHERE mr.id = #{id}
          AND mr.deleted = 0
    </select>

    <!-- 查询患者的病历列表 -->
    <select id="selectByPatientId" resultMap="DetailResultMap">
        SELECT mr.id,
               mr.registration_id,
               r.registration_no,
               mr.patient_id,
               u1.real_name AS patient_name,
               mr.doctor_id,
               u2.real_name AS doctor_name,
               dep.name AS department_name,
               mr.diagnosis,
               mr.visit_time,
               mr.create_time
        FROM medical_record mr
                 LEFT JOIN registration r ON mr.registration_id = r.id
                 LEFT JOIN user u1 ON mr.patient_id = u1.id
                 LEFT JOIN user u2 ON mr.doctor_id = u2.id
                 LEFT JOIN doctor d ON mr.doctor_id = d.user_id
                 LEFT JOIN department dep ON d.department_id = dep.id
        WHERE mr.patient_id = #{patientId}
          AND mr.deleted = 0
        ORDER BY mr.visit_time DESC
    </select>

    <!-- 查询医生的病历列表 -->
    <select id="selectByDoctorId" resultMap="DetailResultMap">
        SELECT mr.id,
               mr.registration_id,
               r.registration_no,
               mr.patient_id,
               u1.real_name AS patient_name,
               u1.gender AS patient_gender,
               mr.doctor_id,
               u2.real_name AS doctor_name,
               mr.diagnosis,
               mr.visit_time,
               mr.create_time
        FROM medical_record mr
                 LEFT JOIN registration r ON mr.registration_id = r.id
                 LEFT JOIN user u1 ON mr.patient_id = u1.id
                 LEFT JOIN user u2 ON mr.doctor_id = u2.id
        WHERE mr.doctor_id = #{doctorId}
          AND mr.deleted = 0
        ORDER BY mr.visit_time DESC
    </select>

    <!-- 分页查询医生历史病历 -->
    <select id="selectDoctorHistoryPage" resultMap="DetailResultMap">
        SELECT mr.id,
        mr.registration_id,
        r.registration_no,
        mr.patient_id,
        u1.real_name AS patient_name,
        u1.gender AS patient_gender,
        TIMESTAMPDIFF(YEAR, u1.birth_date, CURDATE()) AS patient_age,
        mr.doctor_id,
        u2.real_name AS doctor_name,
        dep.name AS department_name,
        mr.chief_complaint,
        mr.present_illness,
        mr.diagnosis,
        mr.prescription,
        mr.advice,
        mr.visit_time,
        mr.create_time,
        mr.update_time
        FROM medical_record mr
        LEFT JOIN registration r ON mr.registration_id = r.id
        LEFT JOIN user u1 ON mr.patient_id = u1.id
        LEFT JOIN user u2 ON mr.doctor_id = u2.id
        LEFT JOIN doctor d ON mr.doctor_id = d.user_id
        LEFT JOIN department dep ON d.department_id = dep.id
        <where>
            mr.doctor_id = #{doctorId} AND mr.deleted = 0
            <if test="patientName != null and patientName != ''">
                AND u1.real_name LIKE CONCAT('%', #{patientName}, '%')
            </if>
            <if test="diagnosis != null and diagnosis != ''">
                AND mr.diagnosis LIKE CONCAT('%', #{diagnosis}, '%')
            </if>
            <if test="startDate != null and startDate != ''">
                AND DATE(mr.visit_time) &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND DATE(mr.visit_time) &lt;= #{endDate}
            </if>
        </where>
        ORDER BY mr.visit_time DESC
    </select>
</mapper>