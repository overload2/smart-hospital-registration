<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hospital.registration.mapper.ScheduleMapper">

    <resultMap id="BaseResultMap" type="com.hospital.registration.entity.Schedule">
        <id property="id" column="id" />
        <result property="doctorId" column="doctor_id" />
        <result property="departmentId" column="department_id" />
        <result property="scheduleDate" column="schedule_date" />
        <result property="timeSlot" column="time_slot" />
        <result property="totalNumber" column="total_number" />
        <result property="remainingNumber" column="remaining_number" />
        <result property="status" column="status" />
        <result property="createTime" column="create_time" />
        <result property="updateTime" column="update_time" />
        <result property="deleted" column="deleted" />
    </resultMap>

    <resultMap id="ScheduleVOResultMap" type="com.hospital.registration.vo.ScheduleVO">
        <id property="id" column="id" />
        <result property="doctorId" column="doctor_id" />
        <result property="doctorName" column="doctor_name" />
        <result property="departmentId" column="department_id" />
        <result property="departmentName" column="department_name" />
        <result property="scheduleDate" column="schedule_date" />
        <result property="timeSlot" column="time_slot" />
        <result property="totalNumber" column="total_number" />
        <result property="remainingNumber" column="remaining_number" />
        <result property="status" column="status" />
        <result property="createTime" column="create_time" />
        <result property="updateTime" column="update_time" />
    </resultMap>

    <sql id="Base_Column_List">
        id, doctor_id, department_id, schedule_date, time_slot,
          total_number, remaining_number, status,
          create_time, update_time, deleted
    </sql>

    <sql id="ScheduleVO_Column_List">
        s.id, s.doctor_id, u.real_name as doctor_name,
          s.department_id, dept.name as department_name,
          s.schedule_date, s.time_slot,
          s.total_number, s.remaining_number, s.status,
          s.create_time, s.update_time
    </sql>

    <!-- 查询指定医生在指定日期和时间段的排班 -->
    <select id="selectByDoctorDateAndTime" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM schedule
        WHERE doctor_id = #{doctorId}
        AND schedule_date = #{scheduleDate}
        AND time_slot = #{timeSlot}
        AND deleted = 0
        LIMIT 1
    </select>

    <!-- 查询指定医生在指定日期和时间段的排班(排除指定ID) -->
    <select id="selectByDoctorDateAndTimeExcludeId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM schedule
        WHERE doctor_id = #{doctorId}
        AND schedule_date = #{scheduleDate}
        AND time_slot = #{timeSlot}
        AND id != #{excludeId}
        AND deleted = 0
        LIMIT 1
    </select>

    <!-- 分页查询排班列表(关联医生和科室信息) -->
    <select id="selectPageWithDetails" resultMap="ScheduleVOResultMap">
        SELECT <include refid="ScheduleVO_Column_List" />
        FROM schedule s
        LEFT JOIN doctor d ON s.doctor_id = d.id AND d.deleted = 0
        LEFT JOIN user u ON d.user_id = u.id AND u.deleted = 0
        LEFT JOIN department dept ON s.department_id = dept.id AND dept.deleted = 0
        <where>
            s.deleted = 0
            <if test="doctorId != null">
                AND s.doctor_id = #{doctorId}
            </if>
            <if test="departmentId != null">
                AND s.department_id = #{departmentId}
            </if>
            <if test="scheduleDate != null">
                AND s.schedule_date = #{scheduleDate}
            </if>
            <if test="status != null">
                AND s.status = #{status}
            </if>
        </where>
        ORDER BY s.schedule_date ASC, s.time_slot ASC
    </select>

    <!-- 根据ID查询排班详情(关联医生和科室信息) -->
    <select id="selectDetailById" resultMap="ScheduleVOResultMap">
        SELECT <include refid="ScheduleVO_Column_List" />
        FROM schedule s
        LEFT JOIN doctor d ON s.doctor_id = d.id AND d.deleted = 0
        LEFT JOIN user u ON d.user_id = u.id AND u.deleted = 0
        LEFT JOIN department dept ON s.department_id = dept.id AND dept.deleted = 0
        WHERE s.id = #{id}
        AND s.deleted = 0
        LIMIT 1
    </select>

    <!-- 查询指定医生的可预约排班列表 -->
    <select id="selectAvailableByDoctor" resultMap="ScheduleVOResultMap">
        SELECT <include refid="ScheduleVO_Column_List" />
        FROM schedule s
        LEFT JOIN doctor d ON s.doctor_id = d.id AND d.deleted = 0
        LEFT JOIN user u ON d.user_id = u.id AND u.deleted = 0
        LEFT JOIN department dept ON s.department_id = dept.id AND dept.deleted = 0
        WHERE s.doctor_id = #{doctorId}
        AND s.schedule_date BETWEEN #{startDate} AND #{endDate}
        AND s.status = 1
        AND s.remaining_number > 0
        AND s.deleted = 0
        ORDER BY s.schedule_date ASC, s.time_slot ASC
    </select>

    <!-- 查询指定科室的可预约排班列表 -->
    <select id="selectAvailableByDepartment" resultMap="ScheduleVOResultMap">
        SELECT <include refid="ScheduleVO_Column_List" />
        FROM schedule s
        LEFT JOIN doctor d ON s.doctor_id = d.id AND d.deleted = 0
        LEFT JOIN user u ON d.user_id = u.id AND u.deleted = 0
        LEFT JOIN department dept ON s.department_id = dept.id AND dept.deleted = 0
        WHERE s.department_id = #{departmentId}
        AND s.schedule_date BETWEEN #{startDate} AND #{endDate}
        AND s.status = 1
        AND s.remaining_number > 0
        AND s.deleted = 0
        ORDER BY s.schedule_date ASC, s.time_slot ASC
    </select>

    <!-- 减少剩余号源数 -->
    <update id="decreaseRemainingNumber">
        UPDATE schedule
        SET remaining_number = remaining_number - 1,
            status = CASE
                         WHEN remaining_number - 1 = 0 THEN 2
                         ELSE status
                END
        WHERE id = #{id}
          AND remaining_number > 0
          AND deleted = 0
    </update>

    <!-- 增加剩余号源数 -->
    <update id="increaseRemainingNumber">
        UPDATE schedule
        SET remaining_number = remaining_number + 1,
            status = CASE
                WHEN status = 2 THEN 1
                ELSE status
            END
        WHERE id = #{id}
            AND remaining_number &lt; total_number
            AND deleted = 0
    </update>

</mapper>
